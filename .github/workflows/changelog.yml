name: è‡ªåŠ¨ç”Ÿæˆæ›´æ–°æ—¥å¿—ï¼ˆæ— æ ‡ç­¾ä¾èµ–ï¼‰

on:
  push:
    branches: [main]

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æ˜¾å¼å£°æ˜ä»“åº“å†™å…¥æƒé™

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true  # ä¿æŒå‡­æ®æœ‰æ•ˆæ€§

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: generate
        run: |
          # è·å–æœ¬æ¬¡æ¨é€çš„æäº¤èŒƒå›´
          BEFORE_SHA="${{ github.event.before}}"
          CURRENT_SHA="${{ github.sha }}"

          # å¤„ç†é¦–æ¬¡æäº¤æˆ–å¼ºåˆ¶æ¨é€çš„æƒ…å†µ
          if [ "$BEFORE_SHA" == "0000000000000000000000000000000000000000" ]; then
            echo "æ£€æµ‹åˆ°é¦–æ¬¡æäº¤æˆ–å¼ºåˆ¶æ¨é€ï¼Œè·å–å…¨éƒ¨æäº¤"
            COMMIT_RANGE="HEAD"
          else
            COMMIT_RANGE="$BEFORE_SHA..$CURRENT_SHA"
          fi

          # ç”Ÿæˆæ—¥æœŸæ ‡è®°
          DATE=$(date +"%Y-%m-%d %H:%M")

          # ç”Ÿæˆå˜æ›´å†…å®¹ï¼ˆMarkdownæ ¼å¼ï¼‰
          echo "å¼€å§‹ç”Ÿæˆå˜æ›´æ—¥å¿—..."
          CHANGES=$(git log --no-merges --pretty=format:"- %s (%h)" $COMMIT_RANGE 2>&1)

          # å¤„ç†æ— æ–°æäº¤çš„æƒ…å†µ
          if [ -z "$CHANGES" ]; then
            echo "::warning::æœ¬æ¬¡æ¨é€æ²¡æœ‰æ–°æäº¤"
            echo "skip_generation=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ„å»ºæ—¥å¿—å†…å®¹
          cat << EOF > changelog.md
          ## æ›´æ–°æ—¥å¿— [$DATE]

          ### æäº¤è®°å½•
          $CHANGES

          [æŸ¥çœ‹å·®å¼‚å¯¹æ¯”](https://github.com/${{ github.repository }}/compare/$BEFORE_SHA...$CURRENT_SHA)
          EOF

          echo "å˜æ›´æ—¥å¿—ç”ŸæˆæˆåŠŸï¼"

      - name: æäº¤å˜æ›´
        if: steps.generate.outputs.skip_generation != 'true'
        run: |
          # é…ç½®Gitèº«ä»½
          git config user.name "è‡ªåŠ¨æ—¥å¿—æœºå™¨äºº"
          git config user.email "ci@example.com"

          # æ·»åŠ å¹¶æäº¤æ–‡ä»¶
          git add changelog.md
          git commit -m "ğŸ“ è‡ªåŠ¨æ›´æ–°å˜æ›´æ—¥å¿— [skip ci]"

          # å¼ºåˆ¶æ¨é€æ›´æ–°ï¼ˆå¤„ç†å†å²é‡å†™æƒ…å†µï¼‰
          git push --force-with-lease origin HEAD:main